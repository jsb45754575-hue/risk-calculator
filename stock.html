<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>주식 트레이더 플랫폼</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://s3.tradingview.com/tv.js"></script>

<style>
body{
  margin:0;
  background:#0f1117;
  font-family:Arial;
  color:white;
}

.container{
  display:flex;
  height:100vh;
}

.chart-area{
  width:66%;
  height:100vh;
  border-right:1px solid #1f2937;
}

.calc-area{
  width:34%;
  padding:25px;
  overflow-y:auto;
  background:#111827;
}

h2{ margin-top:0; }

input{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  background:#1c1f26;
  border:none;
  color:white;
}

button{
  width:100%;
  padding:12px;
  background:#2962ff;
  border:none;
  color:white;
  font-weight:bold;
  cursor:pointer;
}

.result{
  margin-top:20px;
  background:#1c1f26;
  padding:15px;
  border-radius:8px;
}

.good{ color:#00e676; }
.bad{ color:#ff5252; }

canvas{
  margin-top:20px;
  background:#1c1f26;
  padding:10px;
  border-radius:8px;
}
</style>
</head>

<body>

<div class="container">

  <!-- 차트 -->
  <div class="chart-area">
    <div id="tradingview_stock" style="height:100%;"></div>
  </div>

  <!-- 계산기 -->
  <div class="calc-area">
    <h2>주식 리스크 계산</h2>

    <input type="text" id="capital" placeholder="총 자본 (원)">
    <input type="text" id="riskPercent" placeholder="리스크 %">
    <input type="text" id="entry" placeholder="진입가">
    <input type="text" id="stop" placeholder="손절가">
    <input type="text" id="target" placeholder="목표가">

    <button onclick="calculate()">계산하기</button>

    <div class="result" id="output"></div>
    <canvas id="lossChart"></canvas>
  </div>

</div>

<script>
// TradingView
new TradingView.widget({
  "container_id": "tradingview_stock",
  "width": "100%",
  "height": "100%",
  "symbol": "KRX:005930",
  "interval": "D",
  "timezone": "Asia/Seoul",
  "theme": "dark",
  "style": "1",
  "locale": "kr"
});

// ===== 숫자 포맷 함수 =====
function formatNumber(value){
  return Number(value).toLocaleString("ko-KR");
}

function removeComma(value){
  return value.replace(/,/g, "");
}

function addComma(inputId){
  const input = document.getElementById(inputId);
  input.addEventListener("input", function(){
    let value = removeComma(this.value);
    if(!isNaN(value) && value !== ""){
      this.value = formatNumber(value);
    }
  });
}

addComma("capital");
addComma("entry");
addComma("stop");
addComma("target");

// ===== 계산 =====
let chart;

function calculate(){

const capital = parseFloat(removeComma(document.getElementById("capital").value));
const riskPercent = parseFloat(removeComma(document.getElementById("riskPercent").value));
const entry = parseFloat(removeComma(document.getElementById("entry").value));
const stop = parseFloat(removeComma(document.getElementById("stop").value));
const target = parseFloat(removeComma(document.getElementById("target").value));

const riskAmount = capital * (riskPercent/100);
const stopDistance = Math.abs(entry - stop);
const positionSize = riskAmount / stopDistance;
const realLoss = stopDistance * positionSize;
const reward = Math.abs(target - entry) * positionSize;
const rr = reward / realLoss;

let rrColor = rr >= 2 ? "good" : "bad";

document.getElementById("output").innerHTML = `
매수 수량: <b>${formatNumber(positionSize.toFixed(2))}주</b><br>
최대 손실: <b>${formatNumber(realLoss.toFixed(0))}원</b><br>
예상 수익: <b>${formatNumber(reward.toFixed(0))}원</b><br>
손익비(R:R): <b class="${rrColor}">${rr.toFixed(2)}</b>
`;

simulateLoss(capital, riskPercent);
}

// ===== 계좌 감소 그래프 =====
function simulateLoss(capital, riskPercent){

let balances = [];
let balance = capital;

for(let i=0;i<10;i++){
  balance *= (1 - riskPercent/100);
  balances.push(balance);
}

if(chart) chart.destroy();

chart = new Chart(document.getElementById("lossChart"),{
  type:"line",
  data:{
    labels:["1","2","3","4","5","6","7","8","9","10"],
    datasets:[{
      label:"연속 손실 시 계좌 감소",
      data:balances,
      borderColor:"#ff5252",
      fill:false
    }]
  }
});
}
</script>

</body>
</html>